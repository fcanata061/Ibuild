#!/usr/bin/env bash
# ibuild - gerenciador de pacotes source-based com sandbox
# Script central que integra todos os módulos

set -euo pipefail

IBUILD_DIR="$(dirname "$0")"
MODULE_DIR="$IBUILD_DIR/modules"

# Carregar módulos
for mod in utils hooks sandbox dependency build install remove; do
    source "$MODULE_DIR/$mod.sh"
done

usage() {
    cat <<EOF
ibuild - gerenciador de pacotes source-based

Uso:
  ibuild build <pacote>       Construir pacote a partir do source
  ibuild install <pacote>     Instalar pacote (binário ou compilar se faltar)
  ibuild remove <pacote>      Remover pacote instalado
  ibuild update <pacote>      Atualizar pacote (WIP)
  ibuild info <pacote>        Mostrar informações do pacote
  ibuild help                 Mostrar esta ajuda

Diretórios:
  Packages: /var/lib/ibuild/packages
  Sources:  /var/cache/ibuild/sources
  Binaries: /var/cache/ibuild/packages-bin
  Logs:     /var/log/ibuild
EOF
}

# Dispatch
main() {
    local cmd="${1:-}"
    shift || true

    case "$cmd" in
        build)   build_main "$@" ;;
        install) install_main "$@" ;;
        remove)  remove_main "$@" ;;
        update)  log ">> Update ainda não implementado"; exit 1 ;;
        info)
            local pkg="${1:-}"
            if [ -f "/var/lib/ibuild/packages/$pkg/.meta" ]; then
                cat "/var/lib/ibuild/packages/$pkg/.meta"
            elif [ -f "/var/cache/ibuild/packages-bin/$pkg.meta" ]; then
                cat "/var/cache/ibuild/packages-bin/$pkg.meta"
            else
                log "ERRO: Nenhum meta encontrado para $pkg"
                exit 1
            fi
            ;;
        help|"") usage ;;
        *) log "ERRO: comando desconhecido '$cmd'"; usage; exit 1 ;;
    esac
}

main "$@"
